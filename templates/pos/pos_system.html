{% extends 'base.html' %}
{% load static %}
{% block content %}
<style>
  /* Receipt printer-friendly styles */
  @media print {
    body {
      width: 55mm;
      font-size: 11px;
      font-family: monospace;
    }
    .modal-body {
      padding: 0;
      margin: 0;
      width: 100%;
    }
    .table {
      width: 100%;
      border-collapse: collapse;
    }
    .table th, .table td {
      padding: 2px 4px;
      text-align: left;
    }
    hr {
      border: none;
      border-top: 1px dashed #000;
    }
    img {
      max-height: 50px;
    }
    .text-center {
      text-align: center;
    }
  }

  /* On-screen styling for preview */
  .modal-body {
    font-family: monospace;
    max-width: 300px;
    margin: auto;
    font-size: 12px;
  }

  .table th, .table td {
    font-size: 11px;
  }

  .text-center {
    text-align: center;
  }

  .fake-qr {
    display: block;
    margin: 10px auto;
    width: 80px;
    height: 80px;
    background: url('/static/assets/images/qr_code.jpg') no-repeat center center;
    background-size: contain;
  }

  h4, h5, h7 {
    margin: 2px 0;
  }

  p {
    margin: 2px 0;
  }

#invoice-details-body td {
  padding: 4px 8px;
}

#invoice-details-body td:nth-child(1) {
  text-align: left;
  white-space: nowrap; /* Prevent content from wrapping to the next line */
}

#invoice-details-body td:nth-child(n+2) {
  text-align: right;
}

#invoice-details-body tr {
  border-bottom: 1px solid #ddd;
}
</style>


    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Invoice Section -->
            <div class="col-lg-7 invoice-section">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Sales Invoice</h5>
                    </div>
                    <div class="card-body">
                        <!-- Customer Section -->
                        <div class="customer-section mb-3">
                            <div class="d-flex align-items-center">
                                <input type="text" class="form-control" id="customer-input" placeholder="Search customer..." autocomplete="off">
                                <button class="btn btn-outline-primary ms-2" id="add-customer-btn" data-bs-toggle="modal" data-bs-target="#customerModal">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                            </div>
                            <div id="customer-list" class="list-group position-absolute w-50 mt-2"></div>
                        </div>
                        
                        <!-- Add Customer Modal -->
                        <div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="customerModalLabel">Add New Customer</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="customerForm">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label for="name" class="form-label">Full Name</label>
                                                <input type="text" class="form-control" id="name" name="name" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="phone" class="form-label">Phone Number</label>
                                                <input type="text" class="form-control" id="phone" name="phone_number">
                                            </div>
                                            <div class="mb-3">
                                                <label for="email" class="form-label">Email</label>
                                                <input type="email" class="form-control" id="email" name="email" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="shipping_address" class="form-label">Address</label>
                                                <textarea class="form-control" id="shipping_address" name="shipping_address"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Save Customer</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                        <!-- Search Bar -->
                        <!-- <div class="search-bar mb-3">
                            <input type="text" class="form-control" id="item-search" 
                                placeholder="Item name/Barcode/Itemcode [Ctrl+Shift+S]"
                                autocomplete="off">
                        </div> -->

                        <!-- Invoice Table -->
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <!-- <th><strong>ID</strong></th> -->
                                        <th><strong>Item Name</strong></th>
                                        <th><strong>Stock</strong></th>
                                        <th><strong>Quantity</strong></th>
                                        <th><strong>Price</strong></th>
                                        <th><strong>Discount</strong></th>
                                        <th><strong>Tax</strong></th>
                                        <th><strong>Subtotal</strong></th>
                                        
                                    </tr>
                                </thead>
                                <tbody id="invoice-items"></tbody>
                            </table>
                        </div>

                        <!-- Total Section -->
                        <div class="total-section bg-light p-3 rounded">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <p class="mb-1">Quantity:</p>
                                    <h4 id="total-quantity">0</h4>
                                </div>
                                <div class="col-md-4 text-center">
                                    <p class="mb-1">Total Amount:</p>
                                    <h4 id="total-amount">₹0.00</h4>
                                </div>
                                <div class="col-md-4 text-center">
                                    <p class="mb-1">Grand Total:</p>
                                    <h4 id="grand-total">₹0.00</h4>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end mt-3">
                            <!-- <button class="btn btn-danger" id="hold-btn">
                                <i class="fas fa-pause"></i> Hold
                            </button>
                            <button class="btn btn-info" id="multiple-btn">
                                <i class="fas fa-credit-card"></i> Multiple
                            </button>
                            <button class="btn btn-success" id="cash-btn">
                                <i class="fas fa-money-bill"></i> Cash
                            </button> -->
                            <button class="btn btn-primary" id="pay-all-btn">
                                <i class="fas fa-check-circle"></i> Pay All
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div class="col-lg-5 products-section" style="background-color: aliceblue;">
                <!-- Filters -->
                <div class="row mb-3">
                    <div class="col-6" style="position: relative;">
                        <!-- Custom dropdown trigger -->
                        <div id="category-display" style="width: 100%; padding: 10px 15px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; cursor: pointer; background-color: white; text-align: left; position: relative; margin-top: 10px;">
                            All Categories
                            <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%);">▼</span>
                        </div>
                        
                    
                        <!-- Hidden original select for form submission -->
                        <select class="form-select" id="category-filter" style="display: none;">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                        
                        <!-- Custom dropdown menu -->
                        <div id="custom-dropdown" style="position: absolute; width: 100%; max-height: 300px; overflow-y: auto; background: white; border: 1px solid #ccc; border-top: none; z-index: 10; display: none;">
                            <!-- Search box -->
                            <input type="text" id="category-search" style="width: calc(100% - 30px); margin: 10px 15px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Search...">
                            
                            <!-- Dropdown items -->
                            <div class="dropdown-item" data-value="" style="padding: 10px 15px; cursor: pointer; font-size: 14px; background-color: #eee;">All Categories</div>
                            {% for category in categories %}
                            <div class="dropdown-item" data-value="{{ category.id }}" style="padding: 10px 15px; cursor: pointer; font-size: 14px;">{{ category.name }}</div>
                            {% endfor %}
                            
                            <!-- Scroll indicator -->
                            <div style="position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background-color: #d00;"></div>
                        </div>
                    </div>
                </div>

                <!-- Product Grid -->
                <div class="row" id="product-grid">
                    {% for item in items %}
                    <div class="col-md-4 col-sm-6 mb-3 product-card" 
                        data-category="{{ item.category.id }}" 
                        data-brand="{{ item.brand }}">
                        <div class="card h-100">
<!--                            <span class="badge bg-danger quantity-badge">Qty: {{ item.quantity }}</span>-->
                            {% if item.image %}
                            <img src="{{ item.image.url }}" class="card-img-top product-image" alt="{{ item.name }}">
                            {% else %}
                            <img src="{% static 'images/no-image.png' %}" class="card-img-top product-image" alt="No Image">
                            {% endif %}
                            <div class="card-body text-center">
                                <h6 class="card-title">{{ item.name }}</h6>
                                <p class="text-success mb-2">₹{{ item.price }}</p>
                                <button class="btn btn-primary btn-sm w-100 add-to-invoice" 
                                        data-id="{{ item.id }}"
                                        data-name="{{ item.name }}"
                                        data-price="{{ item.price }}"
                                        data-stock="{{ item.quantity }}">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Hold Invoice Modal -->
    <!-- <div class="modal fade" id="holdInvoiceModal" tabindex="-1" aria-labelledby="holdInvoiceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="holdInvoiceModalLabel">Hold Invoice</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Same Reference will replace the old list if exist!</p>
                    <input type="text" class="form-control" id="reference-number" placeholder="Enter Reference Number">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="hold-invoice-btn">OK</button>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Multiple Payments Modal -->
    <!-- <div class="modal fade" id="multiplePaymentsModal" tabindex="-1" aria-labelledby="multiplePaymentsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="multiplePaymentsModalLabel">Multiple Payments</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="payment-amount" class="form-label">Amount</label>
                        <input type="number" class="form-control" id="payment-amount" placeholder="Enter Amount">
                    </div>
                    <div class="mb-3">
                        <label for="payment-type" class="form-label">Payment Type</label>
                        <select class="form-select" id="payment-type">
                            <option value="cash">Cash</option>
                            <option value="card">Card</option>
                            <option value="upi">UPI</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="payment-note" class="form-label">Payment Note</label>
                        <input type="text" class="form-control" id="payment-note" placeholder="Enter Payment Note">
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p>Total Items: <span id="modal-total-items">0</span></p>
                            <p>Total: ₹<span id="modal-total">0.00</span></p>
                            <p>Discount(-): ₹<span id="modal-discount">0.00</span></p>
                            <p>Total Payable: ₹<span id="modal-total-payable">0.00</span></p>
                        </div>
                        <div class="col-md-6">
                            <p>Total Paying: ₹<span id="modal-total-paying">0.00</span></p>
                            <p>Balance: ₹<span id="modal-balance">0.00</span></p>
                            <p>Change Return: ₹<span id="modal-change-return">0.00</span></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-payment-btn">Save</button>
                    <button type="button" class="btn btn-success" id="save-print-payment-btn">Save & Print</button>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Pay All Modal -->
    <div class="modal fade" id="payAllModal" tabindex="-1" aria-labelledby="payAllModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="payAllModalLabel">Invoice Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<div class="text-center">
  <img src="{{ organization.logo.url }}" alt="Organization Logo" height="100">
  <p> TAX INVOICE </p>
  <h7 style="display: block; margin-bottom: 8px;">TRN: 100069993200003</h7>
  <h7 style="display: block;">ADNOC Distribution</h7>

<p>
  P.O Box 4188, AbuDhabi UAE<br>
  892:CAR CARE CENTRE
</p>

  ---------------------------------------
</div>


<table style="border-collapse: collapse; width: 100%;">
  <thead>
    <tr>
      <th style="border: none; padding: 4px 8px; font-weight: normal; text-align: left; width: 40%;">Item</th>
      <th style="border: none; padding: 4px 8px; font-weight: normal; text-align: right; width: 20%;">Qty</th>
      <th style="border: none; padding: 4px 8px; font-weight: normal; text-align: right; width: 20%;">Price</th>
      <th style="white-space: nowrap; border: none; padding: 4px 8px; font-weight: normal; text-align: right; width: 20%;">Subtotal-AED</th>
    </tr>
  </thead>
  <tbody id="invoice-details-body">

  </tbody>
</table>





                    ---------------------------------------
                    <div class="row text-center">
                      <div class="col-md-12 me-auto">

                        <!-- Section 1: Payment Info -->
                    <div class="payment-info">
                      <p style="display: flex; justify-content: space-between;">
                        Total Amount <span id="invoice-tax-amount">4.05</span>
                      </p>
                      <p style="display: flex; justify-content: space-between;">
                        Payment <span id="invoice-total-discount"></span>
                      </p>
                      <p style="display: flex; justify-content: space-between;">
                        CASH PAYMENT <span id="invoice-total">85.00</span>
                      </p>
                    </div>

                        ---------------------------------------
                        <!-- Section 2: Rewards Info -->
                        <div class="rewards-info">

                          <p>You could have earned points!</p>
                          <p>Sign up for ADNOC Rewards Now!</p>
                          <div class="fake-qr"></div>
                        </div>
                        ---------------------------------------
                        <div>
                          <h7>Price Inclusive of VAT</h7>
                          <p>VAT Summary</p>

                        <div style="width: 100%;">
                          <div id="vat-section" style="width: 100%;">
                            <div style="display: flex; padding-bottom: 4px; font-weight: bold;">
                              <div style="flex: 1;">VAT Code</div>
                              <div style="flex: 1;">Amount</div>
                              <div style="flex: 1;">VAT Rate</div>
                              <div style="flex: 1;">VAT (AED)</div>
                            </div>
                          </div>
                        </div>

                        </div>
                          ---------------------------------------
                        <!-- Section 3: Receipt Details -->
                            <form method="post">
                              {% csrf_token %}

                              <div class="receipt-details" style="text-align: left;">
                                <p>Date: <span id="date">{{ invoice.created_at|date:"d-m-Y H:i:s" }}</span></p>

<p>Receipt No:
  <input type="text" name="receipt_number" id="receipt_number" value="{{ invoice.receipt_number }}" />
</p>

                                <p>Invoice No:
                                  <span>20250</span>
                                  <input type="text" name="invoice_suffix" value="{{ invoice.invoice_suffix }}" required />
                                </p>

                            <p>Pump No:
                                <input type="text" name="pump_number" value="{{ invoice.pump_number }}" />
                            </p>


                                <p>Vehicle No:
                                  <input type="text" name="vehicle_no" value="{{ invoice.vehicle_no }}" />
                                </p>



<p>RRN:
  <span id="rrn-preview">
    {% if invoice.receipt_number %}510410{{ invoice.receipt_number }}{% else %}510410{% endif %}
  </span>
</p>
                                <p>Attendant ID:
                                  <span id="attendant">762004910000295735</span>
                                </p>

                                <p>Employee ID:
                                  <span id="employee">762004910000295735</span>
                                </p>

                                <p>TID:
                                  <span id="tid">670-V3.17 e 3 SN P257233T20060</span>
                                </p>
                              </div>
                            </form>


                      </div>
                    </div>

                    ---------------------------------------
                  <div class="fake-qr"></div>
                  <p class="text-center">Claim Rewards QR</p>
                    <br>
                    <p class="text-center">Thank You</p>
                    <p class="text-center">Contact Us 800300</p>
                  <p class="text-center">www.adnocdistribution.ae</p>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="save-invoice-btn" onclick="saveInvoice()">Save</button>
                <button type="button" class="btn btn-success" id="save-print-invoice-btn" onclick="printInvoice()">Save & Print</button>
                </div>
                </div>
            </div>
    </div>
    </div>

    {% block extra_css %}
    <style>
        .product-card {
            transition: transform 0.2s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            height: 120px;
            object-fit: contain;
            padding: 10px;
        }
        
        .quantity-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            z-index: 1;
        }
        
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .invoice-section {
                order: 2;
                margin-top: 20px;
            }
            
            .products-section {
                order: 1;
            }
        }
    </style>
    {% endblock %}

    {% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    $(document).ready(function() {
        console.log("jQuery Loaded:", typeof jQuery !== 'undefined');
        
        // Add item to invoice
        $(document).on('click', '.add-to-invoice', function() {
            const itemId = $(this).data('id');
            const itemName = $(this).data('name');
            const itemPrice = $(this).data('price');
            const itemStock = $(this).data('stock');
        
            console.log("Product clicked:", itemId, itemName, itemPrice, itemStock);
        
            const existingRow = $(`#invoice-items tr[data-id="${itemId}"]`);
            if (existingRow.length) {
                const qtyInput = existingRow.find('input.quantity-input');
                const currentQty = parseInt(qtyInput.val());
                if (currentQty < itemStock) {
                    qtyInput.val(currentQty + 1);
                    updateRowTotal(existingRow);
                }
            } else {
                const newRow = `
                    <tr data-id="${itemId}">
                        <td>${itemName}</td>
                        <td>${itemStock}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm quantity-input" 
                                value="1" min="1" max="${itemStock}">
                        </td>
                        <td class="item-price">${itemPrice}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm discount-input" 
                                value="0" min="0">
                        </td>
                        <td>
                            <input type="number" class="form-control form-control-sm tax-input" 
                                value="0" min="0">
                        </td>
                        <td class="subtotal">${itemPrice}</td>
                        <td>
                            <button class="btn btn-danger btn-sm remove-item">×</button>
                        </td>
                    </tr>
                `;
                $('#invoice-items').append(newRow);
                console.log("Product added to table:", newRow);
            }
            updateTotals();
        });

        // Update row total
        function updateRowTotal(row) {
            const qty = parseInt(row.find('input.quantity-input').val());
            const price = parseFloat(row.find('.item-price').text());
            const discount = parseFloat(row.find('.discount-input').val()) || 0;
            const tax = parseFloat(row.find('.tax-input').val()) || 0;
            const subtotal = (qty * price) - discount + (qty * price * tax / 100);
            row.find('.subtotal').text(subtotal.toFixed(2));
            updateTotals();
        }

        // Update totals
        function updateTotals() {
            let totalQuantity = 0;
            let totalAmount = 0;
            $('#invoice-items tr').each(function() {
                totalQuantity += parseInt($(this).find('input.quantity-input').val()) || 0;
                totalAmount += parseFloat($(this).find('.subtotal').text()) || 0;
            });
            $('#total-quantity').text(totalQuantity);
            $('#total-amount').text(totalAmount.toFixed(2));
            $('#grand-total').text(totalAmount.toFixed(2));
        }

        // Handle quantity change
        $(document).on('input', '.quantity-input', function() {
            const row = $(this).closest('tr');
            updateRowTotal(row);
        });

        // Handle discount and tax change
        $(document).on('input', '.discount-input, .tax-input', function() {
            const row = $(this).closest('tr');
            updateRowTotal(row);
        });

        // Remove item
        $(document).on('click', '.remove-item', function() {
            $(this).closest('tr').remove();
            updateTotals();
        });

        // Hold Invoice
        $('#hold-btn').click(function() {
            $('#holdInvoiceModal').modal('show');
        });

        $('#hold-invoice-btn').click(function() {
            const referenceNumber = $('#reference-number').val();
            if (referenceNumber) {
                alert(`Invoice held with reference number: ${referenceNumber}`);
                $('#holdInvoiceModal').modal('hide');
            } else {
                alert("Please enter a reference number!");
            }
        });

        // Multiple Payments
        $('#multiple-btn').click(function() {
            $('#modal-total-items').text($('#total-quantity').text());
            $('#modal-total').text($('#total-amount').text());
            $('#modal-total-payable').text($('#grand-total').text());
            $('#multiplePaymentsModal').modal('show');
        });

        $('#save-payment-btn').click(function() {
            alert("Payment saved!");
            $('#multiplePaymentsModal').modal('hide');
        });

        $('#save-print-payment-btn').click(function() {
            alert("Payment saved and printed!");
            $('#multiplePaymentsModal').modal('hide');
        });


    // Pay All
    $('#pay-all-btn').click(function() {
        $('#invoice-details-body').empty();
        let totalTax = 0;
        let totalDiscount = 0;
        let totalAmount = 0;

        $('#invoice-items tr').each(function() {
            const itemName = $(this).find('td').eq(0).text();
            const price = parseFloat($(this).find('.item-price').text());
            const quantity = parseInt($(this).find('.quantity-input').val());
            const discount = parseFloat($(this).find('.discount-input').val()) || 0;
            const tax = parseFloat($(this).find('.tax-input').val()) || 0;
            const subtotal = (price * quantity) - discount + (price * quantity * tax / 100);

            // Update totals
            totalTax += (price * quantity * tax / 100);
            totalDiscount += discount;
            totalAmount += subtotal;

            // Add row to the modal table
            $('#invoice-details-body').append(`
                <tr>

                    <td>${itemName}</td>
                    <td>${quantity}</td>
                    <td>${price.toFixed(2)}</td>

                    <td>${subtotal.toFixed(2)}</td>
                </tr>
            `);
        });

    // Clear previous VAT summary rows
    $('#vat-section div:not(:first-child)').remove();

    // Calculate total subtotal again
    let totalSubtotal = 0;
    $('#invoice-details-body tr').each(function () {
        const subtotalText = $(this).find('td:last').text();
        const subtotal = parseFloat(subtotalText);
        if (!isNaN(subtotal)) {
            totalSubtotal += subtotal;
        }
    });

    // Calculate VAT
    const vatRate = 0.05;
    const amountWithoutVAT = (totalSubtotal * (1 - vatRate)).toFixed(2);
    const vatAmount = (totalSubtotal * vatRate).toFixed(2);

    // Add VAT row to #vat-section
// Clear previous VAT section
$('#vat-section').empty();

// Add VAT table header (titles) dynamically
// Clear previous VAT section
$('#vat-section').empty();

// Add VAT table header (titles) dynamically (clean and aligned)
$('#vat-section').append(`
  <div style="display: flex; padding: 4px 0; font-weight: bold;">
    <div style="flex: 1;">VAT Code</div>
    <div style="flex: 1;">Amount</div>
    <div style="flex: 1;">VAT Rate</div>
    <div style="flex: 1;">VAT (AED)</div>
  </div>
`);

// Add the VAT value row
$('#vat-section').append(`
  <div style="display: flex; padding-top: 4px;">
    <div style="flex: 1;">C</div>
    <div style="flex: 1;">${amountWithoutVAT}</div>
    <div style="flex: 1;">5%</div>
    <div style="flex: 1;">${vatAmount}</div>
  </div>
`);







        // Update the modal with calculated totals
        $('#invoice-tax-amount').text(totalAmount.toFixed(2));

        $('#invoice-total').text(totalAmount.toFixed(2));

        // Show the modal
        $('#payAllModal').modal('show');
    });

        // Save Invoice
        $('#save-invoice-btn').click(function() {
            // Here you can add the logic to save the invoice to the database
            alert("Invoice saved!");
            $('#payAllModal').modal('hide');
        });

        // Save and Print Invoice
$('#save-print-invoice-btn').click(function () {
    // Optionally: save invoice logic here
    $('#payAllModal').modal('hide');

    // Print after modal is hidden (to prevent overlap)
    setTimeout(() => {
        printInvoice();
    }, 500);
});


        // Function to print the invoice
        function printInvoice() {
                // Populate the print-only fields
                document.getElementById('print-customer-name').textContent = document.getElementById('customer-name').value;
                document.getElementById('print-customer-address').textContent = document.getElementById('customer-address').value;
                document.getElementById('print-customer-phone').textContent = document.getElementById('customer-phone').value;
                        const printContents = document.getElementById('payAllModal').innerHTML;
            const originalContents = document.body.innerHTML;

            document.body.innerHTML = printContents;
            window.print();
            document.body.innerHTML = originalContents;
            window.location.reload(); // Reload the page to restore the original content
        }
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const categoryDisplay = document.getElementById('category-display');
        const customDropdown = document.getElementById('custom-dropdown');
        const categorySearch = document.getElementById('category-search');
        const dropdownItems = document.querySelectorAll('.dropdown-item');
        const categoryFilter = document.getElementById('category-filter');
        const productGrid = document.getElementById('product-grid');
        const productCards = document.querySelectorAll('.product-card');

        // Toggle dropdown
        categoryDisplay.addEventListener('click', function() {
            const isVisible = customDropdown.style.display === 'block';
            customDropdown.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                categorySearch.focus();
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            if (!categoryDisplay.contains(event.target) && !customDropdown.contains(event.target)) {
                customDropdown.style.display = 'none';
            }
        });

        // Select category
        dropdownItems.forEach(item => {
            item.addEventListener('click', function() {
                // Update display
                categoryDisplay.textContent = this.textContent;
                categoryDisplay.appendChild(document.createElement('span')).textContent = '▼';
                categoryDisplay.querySelector('span').style.position = 'absolute';
                categoryDisplay.querySelector('span').style.right = '15px';
                categoryDisplay.querySelector('span').style.top = '50%';
                categoryDisplay.querySelector('span').style.transform = 'translateY(-50%)';

                // Update actual select element
                categoryFilter.value = this.dataset.value;

                // Update styling
                dropdownItems.forEach(i => i.style.backgroundColor = '');
                this.style.backgroundColor = '#eee';

                // Hide dropdown
                customDropdown.style.display = 'none';

                // Filter products based on selected category
                filterProducts(this.dataset.value);
            });
        });

        // Filter categories by search
        categorySearch.addEventListener('input', function() {
            const searchValue = this.value.toLowerCase();
            dropdownItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchValue)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        });

        // Function to filter products based on category
        function filterProducts(categoryId) {
            productCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                if (categoryId === "" || cardCategory === categoryId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Initial filter to show all products
        filterProducts("");
    });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const customerInput = document.getElementById("customer-input");
            const customerList = document.getElementById("customer-list");
            const customerForm = document.getElementById("customerForm");

            // Search customer
            customerInput.addEventListener("input", function() {
                let query = this.value.trim();
                if (query.length > 1) {
                    fetch(`/search-customer/?query=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        customerList.innerHTML = "";
                        data.forEach(customer => {
                            let item = document.createElement("button");
                            item.classList.add("list-group-item", "list-group-item-action");
                            item.textContent = `${customer.name} (${customer.phone})`;
                            item.onclick = () => {
                                customerInput.value = customer.name;
                                customerList.innerHTML = ""; // Clear dropdown
                            };
                            customerList.appendChild(item);
                        });
                    });
                } else {
                    customerList.innerHTML = "";
                }
            });

            // Submit new customer form
            customerForm.addEventListener("submit", function(event) {
                event.preventDefault();
                let formData = new FormData(this);

                fetch("{% url 'frontend:create_customer' %}", {
                    method: "POST",
                    body: formData,
                    headers: {
                        "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Customer added successfully!");
                        customerInput.value = data.name;
                        customerList.innerHTML = "";
                        document.getElementById("customerModal").click(); // Close modal
                    } else {
                        alert("Error adding customer!");
                    }
                })
                .catch(error => console.error("Error:", error));
            });
        });

document.addEventListener('DOMContentLoaded', function () {
    const invoiceSuffixInput = document.getElementById('invoice_suffix');
    const invoiceNumberSpan = document.getElementById('invoice-number-preview');
    const receiptNumberInput = document.getElementById('receipt_number');
    const rrnPreview = document.getElementById('rrn-preview');

    // Update invoice number when suffix changes
    if (invoiceSuffixInput && invoiceNumberSpan) {
        invoiceSuffixInput.addEventListener('input', function () {
            const suffix = invoiceSuffixInput.value.trim();
            invoiceNumberSpan.textContent = suffix ? `20250${suffix}` : '';
        });
    }

    // ✅ Update RRN when receipt number changes
    if (receiptNumberInput && rrnPreview) {
        receiptNumberInput.addEventListener('input', function () {
            const receipt = receiptNumberInput.value.trim();
            rrnPreview.textContent = receipt ? `510410${receipt}` : '510410';
        });
    }
});

// Save Invoice
function saveInvoice(shouldPrint = false) {
    // Grab values from modal form fields
    const receiptNumber = document.querySelector('input[name="receipt_number"]').value;
    const invoiceSuffix = document.querySelector('input[name="invoice_suffix"]').value;
    const pumpNumber = document.querySelector('select[name="pump_number"]').value;
    const vehicleNo = document.querySelector('input[name="vehicle_no"]').value;

    // ✅ Correct way to get invoice number from span
    const invoiceNumber = document.getElementById('invoice-number-preview').textContent.trim();

    const rrnText = document.querySelector('#rrn-preview').innerText.trim();
    const attendantId = document.querySelector('#attendant').innerText.trim();
    const employeeId = document.querySelector('#employee').innerText.trim();
    const tid = document.querySelector('#tid').innerText.trim();

    // Build data object
    const invoiceData = {
        receipt_number: receiptNumber,
        invoice_suffix: invoiceSuffix,
        pump_number: pumpNumber,
        vehicle_no: vehicleNo,
        invoice_number: invoiceNumber,
        rrn: rrnText,
        attendant_id: attendantId,
        employee_id: employeeId,
        tid: tid
    };

    fetch("{% url 'frontend:save_sale' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify(invoiceData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Invoice saved successfully!");
            if (shouldPrint) {
                printInvoice();
            }
        } else {
            alert("Error saving invoice!");
        }
    })
    .catch(error => console.error("Error:", error));
}

// Button handlers
document.getElementById('save-invoice-btn').addEventListener('click', function() {
    saveInvoice(false);
});

document.getElementById('save-print-invoice-btn').addEventListener('click', function() {
    saveInvoice(true);
});

function printInvoice() {
    const modalBody = document.querySelector('#payAllModal .modal-body');

    // Create a new print window
    const printWindow = window.open('', '_blank');

    // Try to copy styles from the main document (some may be blocked)
    const dynamicStyles = Array.from(document.styleSheets)
        .map(styleSheet => {
            try {
                return Array.from(styleSheet.cssRules)
                    .map(rule => rule.cssText)
                    .join('');
            } catch (e) {
                return ''; // Skip inaccessible stylesheet
            }
        })
        .join('\n');

    // Manual custom CSS styles for consistent print layout
    const customStyles = `
        body {
            width: 55mm;
            font-size: 11px;
            font-family: monospace;
        }
        .modal-body {
            padding: 0;
            margin: 0;
            width: 100%;
            font-family: monospace;
            max-width: 300px;
            font-size: 12px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 2px 4px;
            font-size: 11px;
            text-align: left;
        }
        hr {
            border: none;
            border-top: 1px dashed #000;
        }
        img {
            max-height: 50px;
        }
        .text-center {
            text-align: center;
        }
        .fake-qr {
            display: block;
            margin: 10px auto;
            width: 80px;
            height: 80px;
            background: url('/static/assets/images/qr_code.jpg') no-repeat center center;
            background-size: contain;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        h4, h5, h7, p {
            margin: 2px 0;
        }
        #invoice-details-body td {
            padding: 4px 8px;
        }
        #invoice-details-body td:nth-child(1) {
            text-align: left;
            white-space: nowrap;
        }
        #invoice-details-body td:nth-child(n+2) {
            text-align: right;
        }
        #invoice-details-body tr {
            border-bottom: 1px solid #ddd;
        }
    `;

    // Inject combined styles and modal content into the print window
    printWindow.document.write(`
        <html>
        <head>
            <title>Invoice</title>
            <style>
                ${dynamicStyles}
                ${customStyles}
            </style>
        </head>
        <body onload="window.print(); window.close();">
            <div class="modal-body">
                ${modalBody.innerHTML}
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();


}





    </script>
   
{% endblock %}
{% endblock %}